<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr·ª£ L√Ω G·ª£i √ù Th·∫£o Lu·∫≠n</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i th∆∞ vi·ªán Marked.js ƒë·ªÉ render Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* S·ª≠ d·ª•ng font Inter cho to√†n b·ªô trang */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f8f9fa;
        }
        /* T√πy ch·ªânh thanh cu·ªôn cho ƒë·∫πp h∆°n */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* CSS cho spinner loading */
        .loader {
            width: 30px;
            height: 30px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981; /* M√†u xanh l√° c√¢y c·ªßa Tailwind: emerald-500 */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* T√πy ch·ªânh cho khu v·ª±c output */
        #output-container {
            min-height: 150px;
            padding: 1.5rem;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* Ki·ªÉu cho th·∫ª H3 trong output */
        #output-container h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.25rem;
        }
        /* Ki·ªÉu cho danh s√°ch (ul/ol) trong output */
        #output-container ul, #output-container ol {
            padding-left: 1.5rem;
            list-style: disc;
        }
        #output-container li {
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 tracking-tight">G·ª£i √ù Th·∫£o Lu·∫≠n <span class="text-emerald-500">Th√¥ng Minh</span></h1>
            <p class="text-gray-500 mt-2">Ph√¢n t√≠ch bi√™n b·∫£n h·ªçp v√† t·∫°o c√°c ƒëi·ªÉm th·∫£o lu·∫≠n c√≥ c·∫•u tr√∫c.</p>
        </header>

        <section class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">1. Nh·∫≠p Bi√™n B·∫£n/N·ªôi Dung Cu·ªôc H·ªçp</h2>
            <textarea id="meeting-notes" rows="10" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 transition duration-150 ease-in-out resize-none" placeholder="D√°n to√†n b·ªô n·ªôi dung cu·ªôc h·ªçp ho·∫∑c c√°c v·∫•n ƒë·ªÅ c·∫ßn th·∫£o lu·∫≠n v√†o ƒë√¢y..."></textarea>
            
            <button id="generate-button" class="mt-4 w-full sm:w-auto px-6 py-3 bg-emerald-600 text-white font-bold rounded-lg shadow-md hover:bg-emerald-700 transition duration-150 ease-in-out flex items-center justify-center disabled:opacity-50" onclick="generateDiscussionPoints()">
                <span id="button-text">Ph√¢n T√≠ch & G·ª£i √ù Th·∫£o Lu·∫≠n</span>
                <div id="loading-spinner" class="loader hidden ml-3"></div>
            </button>
        </section>

        <section class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">2. K·∫øt Qu·∫£ G·ª£i √ù Th·∫£o Lu·∫≠n</h2>
            
            <!-- Message box cho l·ªói v√† th√¥ng b√°o -->
            <div id="message-box" class="hidden p-3 mb-4 rounded-lg text-sm" role="alert"></div>

            <div id="output-container" class="rounded-lg bg-gray-50 text-gray-800 overflow-x-auto">
                <p class="text-gray-500 italic">K·∫øt qu·∫£ s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y sau khi b·∫°n nh·∫•n n√∫t Ph√¢n T√≠ch.</p>
            </div>
            
            <button id="copy-button" class="mt-4 w-full sm:w-auto px-4 py-2 bg-blue-500 text-white font-medium rounded-lg shadow-md hover:bg-blue-600 transition duration-150 ease-in-out hidden" onclick="copyToClipboard()">
                Sao ch√©p G·ª£i √Ω
            </button>
        </section>
        
        <footer class="mt-8 text-center text-sm text-gray-400">
            S·ª≠ d·ª•ng Gemini API (gemini-2.5-flash-preview-09-2025) ƒë·ªÉ ph√¢n t√≠ch vƒÉn b·∫£n v√† t·∫°o c·∫•u tr√∫c JSON.
        </footer>
    </div>

    <script type="module">
        // Khai b√°o c√°c bi·∫øn to√†n c·ª•c cho Firebase v√† App ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const apiKey = ""; // API Key ƒë∆∞·ª£c cung c·∫•p t·ª± ƒë·ªông trong Canvas
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

        // C·∫•u h√¨nh Schema JSON cho ph·∫£n h·ªìi
        const RESPONSE_SCHEMA = {
            type: "OBJECT",
            properties: {
                main_topics: {
                    type: "ARRAY",
                    description: "X√°c ƒë·ªãnh c√°c √Ω ch√≠nh, g√≥c nh√¨n ho·∫∑c v·∫•n ƒë·ªÅ tr·ªçng t√¢m bao qu√°t to√†n b·ªô n·ªôi dung.",
                    items: {
                        type: "STRING"
                    }
                },
                discussion_groups: {
                    type: "ARRAY",
                    description: "T·∫≠p h·ª£p c√°c g·ª£i √Ω th·∫£o lu·∫≠n theo t·ª´ng nh√≥m v·∫•n ƒë·ªÅ l·ªõn.",
                    items: {
                        type: "OBJECT",
                        properties: {
                            group_title: {
                                type: "STRING",
                                description: "Ti√™u ƒë·ªÅ c·ªßa nh√≥m v·∫•n ƒë·ªÅ (v√≠ d·ª•: Qu·∫£n l√Ω C·ªông t√°c vi√™n, Chuy·ªÉn ƒë·ªïi s·ªë, C√¥ng t√°c ƒê·∫£ng)."
                            },
                            points: {
                                type: "ARRAY",
                                description: "Danh s√°ch 3-5 g·ª£i √Ω th·∫£o lu·∫≠n cho nh√≥m v·∫•n ƒë·ªÅ n√†y.",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        keyword: {
                                            type: "STRING",
                                            description: "T·ª´ kh√≥a ho·∫∑c √Ω ch√≠nh ng·∫Øn g·ªçn."
                                        },
                                        explanation: {
                                            type: "STRING",
                                            description: "Gi·∫£i th√≠ch ng·∫Øn (1 c√¢u): T·∫°i sao c·∫ßn b√†n lu·∫≠n ƒëi·ªÉm n√†y."
                                        }
                                    },
                                    propertyOrdering: ["keyword", "explanation"]
                                }
                            }
                        },
                        propertyOrdering: ["group_title", "points"]
                    }
                },
                closing_prompt: {
                    type: "STRING",
                    description: "M·ªôt c√¢u h·ªèi m·ªü ·ªü cu·ªëi ƒë·ªÉ khuy·∫øn kh√≠ch ng∆∞·ªùi d√πng ch·ªçn ho·∫∑c m·ªü r·ªông √Ω."
                }
            },
            propertyOrdering: ["main_topics", "discussion_groups", "closing_prompt"]
        };


        // H√†m hi·ªÉn th·ªã th√¥ng b√°o
        function showMessage(message, type = 'error') {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = `p-3 mb-4 rounded-lg text-sm transition-all duration-300 ${type === 'error' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;
            box.classList.remove('hidden');
        }

        // H√†m ·∫©n th√¥ng b√°o
        function hideMessage() {
            document.getElementById('message-box').classList.add('hidden');
        }

        // H√†m g·ªçi API v√† x·ª≠ l√Ω Retry (Exponential Backoff)
        async function callGeminiApi(userPrompt, responseSchema) {
            const retries = 3;
            let delay = 1000;
            
            const systemPrompt = `B·∫°n l√† "G·ª¢I √ù TH·∫¢O LU·∫¨N" (Discussion Suggestion Assistant), vai tr√≤ c·ªßa b·∫°n l√† ph√¢n t√≠ch bi√™n b·∫£n cu·ªôc h·ªçp do ng∆∞·ªùi d√πng cung c·∫•p v√† t·∫°o ra c√°c ƒëi·ªÉm th·∫£o lu·∫≠n c√≥ c·∫•u tr√∫c.
            M·ª•c ti√™u l√† gi√∫p ng∆∞·ªùi d√πng hi·ªÉu nhanh, tri·ªÉn khai n·ªôi dung r√µ r√†ng, v√† x√¢y d·ª±ng cu·ªôc th·∫£o lu·∫≠n h·ª£p l√Ω.
            Ng√¥n ng·ªØ s·ª≠ d·ª•ng ph·∫£i l√† ti·∫øng Vi·ªát, ƒë∆°n gi·∫£n, d·ªÖ hi·ªÉu, ph√π h·ª£p nhi·ªÅu ƒë·ªëi t∆∞·ª£ng.

            Y√™u c·∫ßu v·ªÅ C·∫•u tr√∫c Ph·∫£n h·ªìi:
            1. X√°c ƒë·ªãnh r√µ c√°c √Ω ch√≠nh, g√≥c nh√¨n, v·∫•n ƒë·ªÅ tr·ªçng t√¢m bao qu√°t to√†n b·ªô n·ªôi dung.
            2. T·∫°o 3-5 g·ª£i √Ω th·∫£o lu·∫≠n (discussion points) cho M·ªñI nh√≥m v·∫•n ƒë·ªÅ l·ªõn ƒë∆∞·ª£c x√°c ƒë·ªãnh.
            3. M·ªói g·ª£i √Ω th·∫£o lu·∫≠n PH·∫¢I g·ªìm 2 ph·∫ßn: (1) T·ª´ kh√≥a ho·∫∑c √Ω ch√≠nh ng·∫Øn g·ªçn. (2) Gi·∫£i th√≠ch ng·∫Øn (ch·ªâ 1 c√¢u): "T·∫°i sao c·∫ßn b√†n lu·∫≠n ƒëi·ªÉm n√†y."
            4. K·∫øt th√∫c b·∫±ng m·ªôt c√¢u h·ªèi m·ªü ƒë·ªÉ khuy·∫øn kh√≠ch ng∆∞·ªùi d√πng ch·ªçn ho·∫∑c m·ªü r·ªông √Ω.

            B·∫°n PH·∫¢I tr·∫£ l·ªùi d∆∞·ªõi d·∫°ng JSON tu√¢n th·ªß schema ƒë√£ ƒë·ªãnh nghƒ©a.
            `;

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                },
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error("API Error Body:", errorBody);
                        throw new Error(`L·ªói HTTP! status: ${response.status} - ${response.statusText}`);
                    }

                    const result = await response.json();
                    const partText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (partText) {
                        try {
                            return JSON.parse(partText);
                        } catch (e) {
                            console.error("L·ªói Parsing JSON:", partText);
                            throw new Error('Ph·∫£n h·ªìi kh√¥ng ph·∫£i l√† JSON h·ª£p l·ªá.');
                        }
                    } else {
                        throw new Error('ƒê·ªãnh d·∫°ng ph·∫£n h·ªìi API kh√¥ng h·ª£p l·ªá ho·∫∑c n·ªôi dung tr·ªëng.');
                    }

                } catch (error) {
                    if (i === retries - 1) { 
                        throw error; 
                    }
                    await new Promise(resolve => setTimeout(resolve, delay)); 
                    delay *= 2; 
                }
            }
        }

        // H√†m chuy·ªÉn ƒë·ªïi k·∫øt qu·∫£ JSON th√†nh chu·ªói Markdown
        function formatResultToMarkdown(data) {
            let markdown = `## üéØ Ph√¢n T√≠ch v√† G·ª£i √ù Th·∫£o Lu·∫≠n T·ª´ Bi√™n B·∫£n H·ªôp\n\n`;

            // 1. V·∫•n ƒë·ªÅ Tr·ªçng t√¢m
            if (data.main_topics && data.main_topics.length > 0) {
                markdown += `### V·∫•n ƒê·ªÅ Tr·ªçng T√¢m (√ù Ch√≠nh)\n`;
                markdown += data.main_topics.map(topic => `- **${topic}**`).join('\n');
                markdown += `\n\n`;
            }

            // 2. Nh√≥m Th·∫£o Lu·∫≠n
            if (data.discussion_groups && data.discussion_groups.length > 0) {
                markdown += `## üí¨ C√°c Nh√≥m Th·∫£o Lu·∫≠n Chi Ti·∫øt\n\n`;
                data.discussion_groups.forEach(group => {
                    markdown += `### üìå ${group.group_title}\n\n`;
                    if (group.points && group.points.length > 0) {
                        group.points.forEach((point, index) => {
                            markdown += `**${index + 1}. ${point.keyword}**\n`;
                            markdown += `> *Gi·∫£i th√≠ch: ${point.explanation}*\n\n`;
                        });
                    }
                });
            }

            // 3. K·∫øt lu·∫≠n v√† C√¢u h·ªèi m·ªü
            if (data.closing_prompt) {
                 markdown += `\n***\n`;
                 markdown += `**C√¢u h·ªèi m·ªü:** ${data.closing_prompt}`;
            }

            return markdown;
        }

        // H√†m ch√≠nh ƒë·ªÉ ch·∫°y ph√¢n t√≠ch
        window.generateDiscussionPoints = async function() {
            const notes = document.getElementById('meeting-notes').value.trim();
            const outputContainer = document.getElementById('output-container');
            const generateButton = document.getElementById('generate-button');
            const buttonText = document.getElementById('button-text');
            const loadingSpinner = document.getElementById('loading-spinner');
            const copyButton = document.getElementById('copy-button');

            hideMessage();
            outputContainer.innerHTML = '<div class="loader m-8"></div><p class="text-center text-gray-500 mt-4">ƒêang ph√¢n t√≠ch v√† x√¢y d·ª±ng c·∫•u tr√∫c g·ª£i √Ω...</p>';
            generateButton.disabled = true;
            buttonText.textContent = 'ƒêang X·ª≠ L√Ω...';
            loadingSpinner.classList.remove('hidden');
            copyButton.classList.add('hidden');

            if (!notes) {
                showMessage('Vui l√≤ng nh·∫≠p n·ªôi dung bi√™n b·∫£n h·ªçp ƒë·ªÉ b·∫Øt ƒë·∫ßu ph√¢n t√≠ch.', 'error');
                outputContainer.innerHTML = '<p class="text-gray-500 italic">K·∫øt qu·∫£ s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y sau khi b·∫°n nh·∫•n n√∫t Ph√¢n T√≠ch.</p>';
                generateButton.disabled = false;
                buttonText.textContent = 'Ph√¢n T√≠ch & G·ª£i √ù Th·∫£o Lu·∫≠n';
                loadingSpinner.classList.add('hidden');
                return;
            }

            // T·∫°o prompt cho API
            const userPrompt = `Ph√¢n t√≠ch bi√™n b·∫£n cu·ªôc h·ªçp sau v√† t·∫°o c√°c ƒëi·ªÉm th·∫£o lu·∫≠n c√≥ c·∫•u tr√∫c theo y√™u c·∫ßu:
            ---
            ${notes}
            ---
            `;

            try {
                const jsonResponse = await callGeminiApi(userPrompt, RESPONSE_SCHEMA);
                
                // Chuy·ªÉn ƒë·ªïi JSON sang Markdown
                const markdownResult = formatResultToMarkdown(jsonResponse);

                // Render Markdown sang HTML v√† hi·ªÉn th·ªã
                outputContainer.innerHTML = marked.parse(markdownResult);
                
                // L∆∞u tr·ªØ k·∫øt qu·∫£ Markdown v√†o thu·ªôc t√≠nh data-content ƒë·ªÉ copy sau n√†y
                outputContainer.setAttribute('data-markdown-content', markdownResult);

                showMessage('Ph√¢n t√≠ch th√†nh c√¥ng! D∆∞·ªõi ƒë√¢y l√† c√°c g·ª£i √Ω th·∫£o lu·∫≠n.', 'success');
                copyButton.classList.remove('hidden');

            } catch (error) {
                console.error("L·ªói Gemini API:", error);
                showMessage(`L·ªói trong qu√° tr√¨nh ph√¢n t√≠ch: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i.`, 'error');
                outputContainer.innerHTML = '<p class="text-gray-500 italic">ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng ki·ªÉm tra console log ƒë·ªÉ bi·∫øt chi ti·∫øt.</p>';
            } finally {
                generateButton.disabled = false;
                buttonText.textContent = 'Ph√¢n T√≠ch & G·ª£i √ù Th·∫£o Lu·∫≠n';
                loadingSpinner.classList.add('hidden');
            }
        };

        // H√†m sao ch√©p n·ªôi dung ƒë√£ ƒë·ªãnh d·∫°ng Markdown
        window.copyToClipboard = function() {
            const outputContainer = document.getElementById('output-container');
            const markdownContent = outputContainer.getAttribute('data-markdown-content');
            
            if (markdownContent) {
                // D√πng document.execCommand('copy') ƒë·ªÉ ƒë·∫£m b·∫£o ho·∫°t ƒë·ªông trong iFrame
                const tempTextArea = document.createElement("textarea");
                tempTextArea.value = markdownContent;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                try {
                    document.execCommand('copy');
                    showMessage('ƒê√£ sao ch√©p n·ªôi dung (Markdown) v√†o clipboard!', 'success');
                } catch (err) {
                    console.error('Kh√¥ng th·ªÉ sao ch√©p: ', err);
                    showMessage('Kh√¥ng th·ªÉ sao ch√©p. Vui l√≤ng sao ch√©p th·ªß c√¥ng.', 'error');
                }
                document.body.removeChild(tempTextArea);
            } else {
                showMessage('Kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ sao ch√©p.', 'error');
            }
        }
    </script>
</body>
</html>
