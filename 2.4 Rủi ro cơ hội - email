<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr·ª£ L√Ω G·ª£i √ù Th·∫£o Lu·∫≠n</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i th∆∞ vi·ªán Marked.js ƒë·ªÉ render Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* S·ª≠ d·ª•ng font Inter cho to√†n b·ªô trang */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f8f9fa;
        }
        /* T√πy ch·ªânh thanh cu·ªôn cho ƒë·∫πp h∆°n */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* CSS cho spinner loading */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #10b981; /* M√†u xanh l√° c√¢y c·ªßa Tailwind: emerald-500 */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* T√πy ch·ªânh cho khu v·ª±c output */
        #output-container {
            min-height: 150px;
            padding: 1.5rem;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* Ki·ªÉu cho th·∫ª H3 trong output */
        #output-container h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.25rem;
        }
        /* Ki·ªÉu cho danh s√°ch (ul/ol) trong output */
        #output-container ul, #output-container ol {
            padding-left: 1.5rem;
            list-style: disc;
        }
        #output-container li {
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 tracking-tight">Tr·ª£ L√Ω Ph√¢n T√≠ch <span class="text-emerald-500">Cu·ªôc H·ªçp</span></h1>
            <p class="text-gray-500 mt-2">Ph√¢n t√≠ch bi√™n b·∫£n h·ªçp v√† t·∫°o c√°c ƒëi·ªÉm th·∫£o lu·∫≠n, t√≥m t·∫Øt, agenda, h√†nh ƒë·ªông ho·∫∑c email t·ªïng k·∫øt.</p>
        </header>

        <section class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">1. Nh·∫≠p Bi√™n B·∫£n/N·ªôi Dung Cu·ªôc H·ªçp</h2>
            <textarea id="meeting-notes" rows="10" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 transition duration-150 ease-in-out resize-none" placeholder="D√°n to√†n b·ªô n·ªôi dung cu·ªôc h·ªçp ho·∫∑c c√°c v·∫•n ƒë·ªÅ c·∫ßn th·∫£o lu·∫≠n v√†o ƒë√¢y..."></textarea>
            
            <div class="mt-4 flex flex-wrap gap-3">
                <button id="generate-discussion-button" class="px-6 py-3 bg-emerald-600 text-white font-bold rounded-lg shadow-md hover:bg-emerald-700 transition duration-150 ease-in-out flex items-center justify-center disabled:opacity-50" onclick="generateDiscussionPoints()">
                    <span id="discussion-button-text">Ph√¢n T√≠ch & G·ª£i √ù Th·∫£o Lu·∫≠n</span>
                    <div id="discussion-loading-spinner" class="loader hidden ml-3 w-4 h-4"></div>
                </button>

                <!-- FEATURE 2: Summary -->
                <button id="generate-summary-button" class="px-4 py-3 bg-fuchsia-600 text-white font-bold rounded-lg shadow-md hover:bg-fuchsia-700 transition duration-150 ease-in-out flex items-center justify-center disabled:opacity-50" onclick="generateSummary()">
                    <span id="summary-button-text">‚ú® T√≥m T·∫Øt Nhanh (1 ƒêo·∫°n)</span>
                    <div id="summary-loading-spinner" class="loader hidden ml-3 w-4 h-4"></div>
                </button>

                <!-- FEATURE 3: Agenda Draft -->
                <button id="generate-agenda-button" class="px-4 py-3 bg-sky-600 text-white font-bold rounded-lg shadow-md hover:bg-sky-700 transition duration-150 ease-in-out flex items-center justify-center disabled:opacity-50" onclick="generateAgendaDraft()">
                    <span id="agenda-button-text">‚ú® ƒê·ªÅ Xu·∫•t Agenda M·∫´u</span>
                    <div id="agenda-loading-spinner" class="loader hidden ml-3 w-4 h-4"></div>
                </button>
                
                <!-- FEATURE 4: Action Item Extraction -->
                <button id="generate-action-button" class="px-4 py-3 bg-orange-600 text-white font-bold rounded-lg shadow-md hover:bg-orange-700 transition duration-150 ease-in-out flex items-center justify-center disabled:opacity-50" onclick="generateActionItems()">
                    <span id="action-button-text">‚ú® Tr√≠ch Xu·∫•t H√†nh ƒê·ªông & Ng∆∞·ªùi Ph·ª• Tr√°ch</span>
                    <div id="action-loading-spinner" class="loader hidden ml-3 w-4 h-4" style="border-top-color: #ea580c;"></div>
                </button>

                <!-- FEATURE 5: Follow-up Email Draft -->
                <button id="generate-email-button" class="px-4 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out flex items-center justify-center disabled:opacity-50" onclick="generateFollowupEmail()">
                    <span id="email-button-text">‚ú® So·∫°n Th·∫£o Email T√≥m T·∫Øt</span>
                    <div id="email-loading-spinner" class="loader hidden ml-3 w-4 h-4" style="border-top-color: #4f46e5;"></div>
                </button>
                
                <!-- NEW FEATURE 6: Risk & Opportunity Analysis -->
                <button id="generate-risk-button" class="px-4 py-3 bg-teal-600 text-white font-bold rounded-lg shadow-md hover:bg-teal-700 transition duration-150 ease-in-out flex items-center justify-center disabled:opacity-50" onclick="analyzeRisksAndOpportunities()">
                    <span id="risk-button-text">‚ú® Ph√¢n T√≠ch R·ªßi Ro & C∆° H·ªôi</span>
                    <div id="risk-loading-spinner" class="loader hidden ml-3 w-4 h-4" style="border-top-color: #0d9488;"></div>
                </button>

            </div>
        </section>

        <section class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">2. K·∫øt Qu·∫£ G·ª£i √ù Th·∫£o Lu·∫≠n / Ph√¢n T√≠ch</h2>
            
            <!-- Message box cho l·ªói v√† th√¥ng b√°o -->
            <div id="message-box" class="hidden p-3 mb-4 rounded-lg text-sm" role="alert"></div>

            <div id="output-container" class="rounded-lg bg-gray-50 text-gray-800 overflow-x-auto">
                <p class="text-gray-500 italic">K·∫øt qu·∫£ s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y sau khi b·∫°n nh·∫•n n√∫t Ph√¢n T√≠ch.</p>
            </div>
            
            <button id="copy-button" class="mt-4 w-full sm:w-auto px-4 py-2 bg-blue-500 text-white font-medium rounded-lg shadow-md hover:bg-blue-600 transition duration-150 ease-in-out hidden" onclick="copyToClipboard()">
                Sao ch√©p K·∫øt qu·∫£
            </button>
        </section>
        
        <footer class="mt-8 text-center text-sm text-gray-400">
            S·ª≠ d·ª•ng Gemini API (gemini-2.5-flash-preview-09-2025) ƒë·ªÉ ph√¢n t√≠ch vƒÉn b·∫£n v√† t·∫°o c·∫•u tr√∫c JSON/Markdown.
        </footer>
    </div>

    <script type="module">
        // Khai b√°o c√°c bi·∫øn to√†n c·ª•c cho Firebase v√† App ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const apiKey = ""; // API Key ƒë∆∞·ª£c cung c·∫•p t·ª± ƒë·ªông trong Canvas
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

        // --- SCHEMAS ---

        // Schema 1: C·∫•u h√¨nh JSON cho ph·∫£n h·ªìi (Ch·ª©c nƒÉng G·ª£i √ù Th·∫£o Lu·∫≠n)
        const DISCUSSION_SCHEMA = {
            type: "OBJECT",
            properties: {
                main_topics: {
                    type: "ARRAY",
                    description: "X√°c ƒë·ªãnh c√°c √Ω ch√≠nh, g√≥c nh√¨n ho·∫∑c v·∫•n ƒë·ªÅ tr·ªçng t√¢m bao qu√°t to√†n b·ªô n·ªôi dung.",
                    items: {
                        type: "STRING"
                    }
                },
                discussion_groups: {
                    type: "ARRAY",
                    description: "T·∫≠p h·ª£p c√°c g·ª£i √Ω th·∫£o lu·∫≠n theo t·ª´ng nh√≥m v·∫•n ƒë·ªÅ l·ªõn.",
                    items: {
                        type: "OBJECT",
                        properties: {
                            group_title: {
                                type: "STRING",
                                description: "Ti√™u ƒë·ªÅ c·ªßa nh√≥m v·∫•n ƒë·ªÅ (v√≠ d·ª•: Qu·∫£n l√Ω C·ªông t√°c vi√™n, Chuy·ªÉn ƒë·ªïi s·ªë, C√¥ng t√°c ƒê·∫£ng)."
                            },
                            points: {
                                type: "ARRAY",
                                description: "Danh s√°ch 3-5 g·ª£i √Ω th·∫£o lu·∫≠n cho nh√≥m v·∫•n ƒë·ªÅ n√†y.",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        keyword: {
                                            type: "STRING",
                                            description: "T·ª´ kh√≥a ho·∫∑c √Ω ch√≠nh ng·∫Øn g·ªçn."
                                        },
                                        explanation: {
                                            type: "STRING",
                                            description: "Gi·∫£i th√≠ch ng·∫Øn (ch·ªâ 1 c√¢u): T·∫°i sao c·∫ßn b√†n lu·∫≠n ƒëi·ªÉm n√†y."
                                        }
                                    },
                                    propertyOrdering: ["keyword", "explanation"]
                                }
                            }
                        },
                        propertyOrdering: ["group_title", "points"]
                    }
                },
                closing_prompt: {
                    type: "STRING",
                    description: "M·ªôt c√¢u h·ªèi m·ªü ·ªü cu·ªëi ƒë·ªÉ khuy·∫øn kh√≠ch ng∆∞·ªùi d√πng ch·ªçn ho·∫∑c m·ªü r·ªông √Ω."
                }
            },
            propertyOrdering: ["main_topics", "discussion_groups", "closing_prompt"]
        };
        
        // Schema 2: C·∫•u h√¨nh JSON cho ph·∫£n h·ªìi (Ch·ª©c nƒÉng Tr√≠ch Xu·∫•t H√†nh ƒê·ªông)
        const ACTION_ITEM_SCHEMA = {
            type: "ARRAY",
            description: "Danh s√°ch c√°c m·ª•c h√†nh ƒë·ªông ƒë∆∞·ª£c tr√≠ch xu·∫•t t·ª´ bi√™n b·∫£n h·ªçp.",
            items: {
                type: "OBJECT",
                properties: {
                    task: {
                        type: "STRING",
                        description: "M√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ h√†nh ƒë·ªông c·∫ßn th·ª±c hi·ªán."
                    },
                    owner: {
                        type: "STRING",
                        description: "Ng∆∞·ªùi ho·∫∑c nh√≥m ch·ªãu tr√°ch nhi·ªám th·ª±c hi·ªán h√†nh ƒë·ªông. N·∫øu kh√¥ng r√µ, ghi l√† 'Ch∆∞a x√°c ƒë·ªãnh'."
                    },
                    priority: {
                        type: "STRING",
                        description: "ƒê√°nh gi√° m·ª©c ƒë·ªô ∆∞u ti√™n c·ªßa h√†nh ƒë·ªông (Cao, Trung b√¨nh, Th·∫•p)."
                    }
                },
                propertyOrdering: ["task", "owner", "priority"]
            }
        };

        // Schema 3: C·∫•u h√¨nh JSON cho ph·∫£n h·ªìi (Ch·ª©c nƒÉng R·ªßi Ro & C∆° H·ªôi)
        const RISK_OPP_SCHEMA = {
            type: "OBJECT",
            properties: {
                risks: {
                    type: "ARRAY",
                    description: "Danh s√°ch 3-5 r·ªßi ro ho·∫∑c th√°ch th·ª©c ti·ªÅm ·∫©n ƒë∆∞·ª£c ƒë·ªÅ c·∫≠p ho·∫∑c ng·ª• √Ω trong bi√™n b·∫£n h·ªçp.",
                    items: {
                        type: "OBJECT",
                        properties: {
                            risk_description: {
                                type: "STRING",
                                description: "M√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ r·ªßi ro."
                            },
                            mitigation_suggestion: {
                                type: "STRING",
                                description: "ƒê·ªÅ xu·∫•t ng·∫Øn g·ªçn ƒë·ªÉ gi·∫£m thi·ªÉu ho·∫∑c qu·∫£n l√Ω r·ªßi ro n√†y."
                            }
                        },
                        propertyOrdering: ["risk_description", "mitigation_suggestion"]
                    }
                },
                opportunities: {
                    type: "ARRAY",
                    description: "Danh s√°ch 3-5 c∆° h·ªôi ti·ªÅm nƒÉng ho·∫∑c b∆∞·ªõc ti·∫øp theo t√≠ch c·ª±c ƒë∆∞·ª£c ƒë·ªÅ c·∫≠p ho·∫∑c ng·ª• √Ω.",
                    items: {
                        type: "OBJECT",
                        properties: {
                            opportunity_description: {
                                type: "STRING",
                                description: "M√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ c∆° h·ªôi."
                            },
                            action_suggestion: {
                                type: "STRING",
                                description: "ƒê·ªÅ xu·∫•t ng·∫Øn g·ªçn ƒë·ªÉ khai th√°c c∆° h·ªôi n√†y."
                            }
                        },
                        propertyOrdering: ["opportunity_description", "action_suggestion"]
                    }
                }
            },
            propertyOrdering: ["risks", "opportunities"]
        };


        // --- UTILITY FUNCTIONS ---

        // H√†m hi·ªÉn th·ªã th√¥ng b√°o
        function showMessage(message, type = 'error') {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = `p-3 mb-4 rounded-lg text-sm transition-all duration-300 ${type === 'error' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;
            box.classList.remove('hidden');
        }

        // H√†m ·∫©n th√¥ng b√°o
        function hideMessage() {
            document.getElementById('message-box').classList.add('hidden');
        }

        // H√†m thay ƒë·ªïi tr·∫°ng th√°i button v√† spinner
        function setLoadingState(buttonId, isLoading, defaultText) {
            const button = document.getElementById(buttonId);
            const buttonText = button.querySelector('span');
            const loadingSpinner = button.querySelector('.loader');

            button.disabled = isLoading;
            if (isLoading) {
                buttonText.textContent = 'ƒêang X·ª≠ L√Ω...';
                loadingSpinner.classList.remove('hidden');
            } else {
                buttonText.textContent = defaultText;
                loadingSpinner.classList.add('hidden');
            }
        }


        // H√†m g·ªçi API v√† x·ª≠ l√Ω Retry (cho JSON response)
        async function callGeminiApiJson(userPrompt, responseSchema, systemPrompt) {
            return await callGeminiApi(userPrompt, systemPrompt, responseSchema);
        }

        // H√†m g·ªçi API v√† x·ª≠ l√Ω Retry (cho TEXT response)
        async function callGeminiApiText(userPrompt, systemPrompt) {
            return await callGeminiApi(userPrompt, systemPrompt, null);
        }

        // H√†m API g·ªëc v·ªõi logic retry chung
        async function callGeminiApi(userPrompt, systemPrompt, responseSchema) {
            const retries = 3;
            let delay = 1000;
            
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            if (responseSchema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                };
            }

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error("API Error Body:", errorBody);
                        throw new Error(`L·ªói HTTP! status: ${response.status} - ${response.statusText}`);
                    }

                    const result = await response.json();
                    const partText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (partText) {
                        if (responseSchema) {
                            try {
                                return JSON.parse(partText);
                            } catch (e) {
                                console.error("L·ªói Parsing JSON:", partText);
                                throw new Error('Ph·∫£n h·ªìi kh√¥ng ph·∫£i l√† JSON h·ª£p l·ªá.');
                            }
                        } else {
                            return partText;
                        }
                    } else {
                        throw new Error('ƒê·ªãnh d·∫°ng ph·∫£n h·ªìi API kh√¥ng h·ª£p l·ªá ho·∫∑c n·ªôi dung tr·ªëng.');
                    }

                } catch (error) {
                    if (i === retries - 1) { 
                        throw error; 
                    }
                    await new Promise(resolve => setTimeout(resolve, delay)); 
                    delay *= 2; 
                }
            }
        }


        // --- FORMATTING FUNCTIONS ---

        // H√†m chuy·ªÉn ƒë·ªïi k·∫øt qu·∫£ JSON (G·ª£i √Ω Th·∫£o lu·∫≠n) th√†nh chu·ªói Markdown
        function formatDiscussionResultToMarkdown(data) {
            let markdown = `## üéØ Ph√¢n T√≠ch v√† G·ª£i √ù Th·∫£o Lu·∫≠n T·ª´ Bi√™n B·∫£n H·ªôp\n\n`;

            // 1. V·∫•n ƒë·ªÅ Tr·ªçng t√¢m
            if (data.main_topics && data.main_topics.length > 0) {
                markdown += `### V·∫•n ƒê·ªÅ Tr·ªçng T√¢m (√ù Ch√≠nh)\n`;
                markdown += data.main_topics.map(topic => `- **${topic}**`).join('\n');
                markdown += `\n\n`;
            }

            // 2. Nh√≥m Th·∫£o Lu·∫≠n
            if (data.discussion_groups && data.discussion_groups.length > 0) {
                markdown += `## üí¨ C√°c Nh√≥m Th·∫£o Lu·∫≠n Chi Ti·∫øt\n\n`;
                data.discussion_groups.forEach(group => {
                    markdown += `### üìå ${group.group_title}\n\n`;
                    if (group.points && group.points.length > 0) {
                        group.points.forEach((point, index) => {
                            markdown += `**${index + 1}. ${point.keyword}**\n`;
                            markdown += `> *Gi·∫£i th√≠ch: ${point.explanation}*\n\n`;
                        });
                    }
                });
            }

            // 3. K·∫øt lu·∫≠n v√† C√¢u h·ªèi m·ªü
            if (data.closing_prompt) {
                 markdown += `\n***\n`;
                 markdown += `**C√¢u h·ªèi m·ªü:** ${data.closing_prompt}`;
            }

            return markdown;
        }
        
        // H√†m chuy·ªÉn ƒë·ªïi k·∫øt qu·∫£ JSON (M·ª•c H√†nh ƒê·ªông) th√†nh chu·ªói Markdown
        function formatActionItemsToMarkdown(data) {
            if (!data || data.length === 0) {
                return `## ‚ú® Danh S√°ch H√†nh ƒê·ªông C·∫ßn Th·ª±c Hi·ªán\n\nKh√¥ng t√¨m th·∫•y m·ª•c h√†nh ƒë·ªông n√†o r√µ r√†ng trong bi√™n b·∫£n.`;
            }

            let markdown = `## ‚ú® Danh S√°ch H√†nh ƒê·ªông C·∫ßn Th·ª±c Hi·ªán\n\n`;
            
            data.forEach((item, index) => {
                const priority = item.priority || 'Ch∆∞a r√µ';
                let priorityIcon = '‚ö™';
                if (priority.toLowerCase().includes('cao')) {
                    priorityIcon = 'üî¥';
                } else if (priority.toLowerCase().includes('trung b√¨nh')) {
                    priorityIcon = 'üü°';
                } else if (priority.toLowerCase().includes('th·∫•p')) {
                    priorityIcon = 'üü¢';
                }

                markdown += `**${index + 1}. ${item.task}**\n`;
                markdown += `* Ng∆∞·ªùi Ph·ª• Tr√°ch: **${item.owner || 'Ch∆∞a x√°c ƒë·ªãnh'}**\n`;
                markdown += `* ∆Øu Ti√™n: ${priorityIcon} ${priority}\n\n`;
            });

            return markdown;
        }

        // H√†m chuy·ªÉn ƒë·ªïi k·∫øt qu·∫£ JSON (R·ªßi ro/C∆° h·ªôi) th√†nh chu·ªói Markdown
        function formatRiskOppToMarkdown(data) {
            let markdown = `## ‚ú® Ph√¢n T√≠ch R·ªßi Ro v√† C∆° H·ªôi\n\n`;

            // 1. R·ªßi Ro
            markdown += `### ‚ö†Ô∏è R·ªßi Ro v√† Th√°ch Th·ª©c Ti·ªÅm ·∫®n\n\n`;
            if (data.risks && data.risks.length > 0) {
                data.risks.forEach((item, index) => {
                    markdown += `**${index + 1}. R·ªßi ro:** ${item.risk_description}\n`;
                    markdown += `* **ƒê·ªÅ xu·∫•t gi·∫£m thi·ªÉu:** ${item.mitigation_suggestion}\n\n`;
                });
            } else {
                markdown += `* Kh√¥ng t√¨m th·∫•y r·ªßi ro/th√°ch th·ª©c r√µ r√†ng n√†o ƒë∆∞·ª£c ƒë·ªÅ c·∫≠p.\n\n`;
            }

            // 2. C∆° H·ªôi
            markdown += `### üöÄ C∆° H·ªôi v√† B∆∞·ªõc Ti·∫øn T√≠ch C·ª±c\n\n`;
            if (data.opportunities && data.opportunities.length > 0) {
                data.opportunities.forEach((item, index) => {
                    markdown += `**${index + 1}. C∆° h·ªôi:** ${item.opportunity_description}\n`;
                    markdown += `* **ƒê·ªÅ xu·∫•t khai th√°c:** ${item.action_suggestion}\n\n`;
                });
            } else {
                markdown += `* Kh√¥ng t√¨m th·∫•y c∆° h·ªôi ti·ªÅm nƒÉng n√†o ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t.\n\n`;
            }

            return markdown;
        }


        // H√†m hi·ªÉn th·ªã k·∫øt qu·∫£ chung
        function displayResult(markdownContent) {
            const outputContainer = document.getElementById('output-container');
            const copyButton = document.getElementById('copy-button');
            
            outputContainer.innerHTML = marked.parse(markdownContent);
            outputContainer.setAttribute('data-markdown-content', markdownContent);
            copyButton.classList.remove('hidden');
            showMessage('Ph√¢n t√≠ch th√†nh c√¥ng! D∆∞·ªõi ƒë√¢y l√† k·∫øt qu·∫£.', 'success');
        }


        // --- MAIN LLM FEATURES ---

        // CH·ª®C NƒÇNG 1: G·ª£i √ù Th·∫£o Lu·∫≠n (S·ª≠ d·ª•ng JSON Schema)
        window.generateDiscussionPoints = async function() {
            const notes = document.getElementById('meeting-notes').value.trim();
            const buttonId = 'generate-discussion-button';
            
            if (!notes) {
                showMessage('Vui l√≤ng nh·∫≠p n·ªôi dung bi√™n b·∫£n h·ªçp.', 'error');
                return;
            }

            setLoadingState(buttonId, true, 'Ph√¢n T√≠ch & G·ª£i √ù Th·∫£o Lu·∫≠n');
            hideMessage();

            const outputContainer = document.getElementById('output-container');
            outputContainer.innerHTML = '<div class="loader m-8 w-8 h-8"></div><p class="text-center text-gray-500 mt-4">ƒêang ph√¢n t√≠ch v√† x√¢y d·ª±ng c·∫•u tr√∫c g·ª£i √Ω...</p>';

            const systemPrompt = `B·∫°n l√† "G·ª¢I √ù TH·∫¢O LU·∫¨N" (Discussion Suggestion Assistant), vai tr√≤ c·ªßa b·∫°n l√† ph√¢n t√≠ch bi√™n b·∫£n cu·ªôc h·ªçp do ng∆∞·ªùi d√πng cung c·∫•p v√† t·∫°o ra c√°c ƒëi·ªÉm th·∫£o lu·∫≠n c√≥ c·∫•u tr√∫c.
            M·ª•c ti√™u l√† gi√∫p ng∆∞·ªùi d√πng hi·ªÉu nhanh, tri·ªÉn khai n·ªôi dung r√µ r√†ng, v√† x√¢y d·ª±ng cu·ªôc th·∫£o lu·∫≠n h·ª£p l√Ω.
            Ng√¥n ng·ªØ s·ª≠ d·ª•ng ph·∫£i l√† ti·∫øng Vi·ªát, ƒë∆°n gi·∫£n, d·ªÖ hi·ªÉu, ph√π h·ª£p nhi·ªÅu ƒë·ªëi t∆∞·ª£ng.

            Y√™u c·∫ßu v·ªÅ C·∫•u tr√∫c Ph·∫£n h·ªìi:
            1. X√°c ƒë·ªãnh r√µ c√°c √Ω ch√≠nh, g√≥c nh√¨n, v·∫•n ƒë·ªÅ tr·ªçng t√¢m bao qu√°t to√†n b·ªô n·ªôi dung.
            2. T·∫°o 3-5 g·ª£i √Ω th·∫£o lu·∫≠n (discussion points) cho M·ªñI nh√≥m v·∫•n ƒë·ªÅ l·ªõn ƒë∆∞·ª£c x√°c ƒë·ªãnh.
            3. M·ªói g·ª£i √Ω th·∫£o lu·∫≠n PH·∫¢I g·ªìm 2 ph·∫ßn: (1) T·ª´ kh√≥a ho·∫∑c √Ω ch√≠nh ng·∫Øn g·ªçn. (2) Gi·∫£i th√≠ch ng·∫Øn (ch·ªâ 1 c√¢u): "T·∫°i sao c·∫ßn b√†n lu·∫≠n ƒëi·ªÉm n√†y."
            4. K·∫øt th√∫c b·∫±ng m·ªôt c√¢u h·ªèi m·ªü ƒë·ªÉ khuy·∫øn kh√≠ch ng∆∞·ªùi d√πng ch·ªçn ho·∫∑c m·ªü r·ªông √Ω.

            B·∫°n PH·∫¢I tr·∫£ l·ªùi d∆∞·ªõi d·∫°ng JSON tu√¢n th·ªß schema ƒë√£ ƒë·ªãnh nghƒ©a.
            `;
            
            const userPrompt = `Ph√¢n t√≠ch bi√™n b·∫£n cu·ªôc h·ªçp sau v√† t·∫°o c√°c ƒëi·ªÉm th·∫£o lu·∫≠n c√≥ c·∫•u tr√∫c theo y√™u c·∫ßu:
            ---
            ${notes}
            ---
            `;

            try {
                const jsonResponse = await callGeminiApiJson(userPrompt, DISCUSSION_SCHEMA, systemPrompt);
                const markdownResult = formatDiscussionResultToMarkdown(jsonResponse);
                displayResult(markdownResult);

            } catch (error) {
                console.error("L·ªói Gemini API:", error);
                showMessage(`L·ªói trong qu√° tr√¨nh ph√¢n t√≠ch: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i.`, 'error');
                outputContainer.innerHTML = '<p class="text-red-500 italic p-4">ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng ki·ªÉm tra console log ƒë·ªÉ bi·∫øt chi ti·∫øt.</p>';
            } finally {
                setLoadingState(buttonId, false, 'Ph√¢n T√≠ch & G·ª£i √ù Th·∫£o Lu·∫≠n');
            }
        };


        // CH·ª®C NƒÇNG 2: T√ìM T·∫ÆT NHANH (S·ª≠ d·ª•ng Text response)
        window.generateSummary = async function() {
            const notes = document.getElementById('meeting-notes').value.trim();
            const buttonId = 'generate-summary-button';

            if (!notes) {
                showMessage('Vui l√≤ng nh·∫≠p n·ªôi dung bi√™n b·∫£n h·ªçp.', 'error');
                return;
            }

            setLoadingState(buttonId, true, '‚ú® T√≥m T·∫Øt Nhanh (1 ƒêo·∫°n)');
            hideMessage();

            const outputContainer = document.getElementById('output-container');
            outputContainer.innerHTML = '<div class="loader m-8 w-8 h-8 bg-fuchsia-600 border-t-fuchsia-600"></div><p class="text-center text-gray-500 mt-4">ƒêang t√≥m t·∫Øt bi√™n b·∫£n...</p>';

            const systemPrompt = `B·∫°n l√† chuy√™n gia t√≥m t·∫Øt. Nhi·ªám v·ª• c·ªßa b·∫°n l√† ƒë·ªçc bi√™n b·∫£n cu·ªôc h·ªçp v√† t·∫°o ra m·ªôt ƒëo·∫°n vƒÉn ng·∫Øn (t·ªëi ƒëa 5 c√¢u) t√≥m t·∫Øt c√°c quy·∫øt ƒë·ªãnh v√† y√™u c·∫ßu h√†nh ƒë·ªông quan tr·ªçng nh·∫•t. Ph·∫£n h·ªìi ph·∫£i l√† ti·∫øng Vi·ªát v√† ch·ªâ ch·ª©a ƒëo·∫°n t√≥m t·∫Øt.`;
            const userPrompt = `T√≥m t·∫Øt n·ªôi dung sau th√†nh m·ªôt ƒëo·∫°n vƒÉn ng·∫Øn g·ªçn:
            ---
            ${notes}
            ---
            `;

            try {
                const textResponse = await callGeminiApiText(userPrompt, systemPrompt);
                const markdownResult = `## ‚ú® T√≥m T·∫Øt Nhanh Bi√™n B·∫£n\n\n${textResponse}`;
                displayResult(markdownResult);

            } catch (error) {
                console.error("L·ªói Gemini API:", error);
                showMessage(`L·ªói trong qu√° tr√¨nh t√≥m t·∫Øt: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i.`, 'error');
                outputContainer.innerHTML = '<p class="text-red-500 italic p-4">ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng ki·ªÉm tra console log ƒë·ªÉ bi·∫øt chi ti·∫øt.</p>';
            } finally {
                setLoadingState(buttonId, false, '‚ú® T√≥m T·∫Øt Nhanh (1 ƒêo·∫°n)');
            }
        };

        // CH·ª®C NƒÇNG 3: ƒê·ªÄ XU·∫§T AGENDA M·∫™U (S·ª≠ d·ª•ng Text response)
        window.generateAgendaDraft = async function() {
            const notes = document.getElementById('meeting-notes').value.trim();
            const buttonId = 'generate-agenda-button';

            if (!notes) {
                showMessage('Vui l√≤ng nh·∫≠p n·ªôi dung bi√™n b·∫£n h·ªçp.', 'error');
                return;
            }

            setLoadingState(buttonId, true, '‚ú® ƒê·ªÅ Xu·∫•t Agenda M·∫´u');
            hideMessage();

            const outputContainer = document.getElementById('output-container');
            outputContainer.innerHTML = '<div class="loader m-8 w-8 h-8 bg-sky-600 border-t-sky-600"></div><p class="text-center text-gray-500 mt-4">ƒêang x√¢y d·ª±ng b·∫£n nh√°p agenda...</p>';

            const systemPrompt = `B·∫°n l√† tr·ª£ l√Ω t·ªï ch·ª©c cu·ªôc h·ªçp chuy√™n nghi·ªáp. Nhi·ªám v·ª• c·ªßa b·∫°n l√† x√¢y d·ª±ng m·ªôt b·∫£n nh√°p agenda chi ti·∫øt d·ª±a tr√™n c√°c v·∫•n ƒë·ªÅ trong bi√™n b·∫£n cu·ªôc h·ªçp ƒë∆∞·ª£c cung c·∫•p. Agenda ph·∫£i ƒë∆∞·ª£c tr√¨nh b√†y b·∫±ng Markdown v·ªõi c√°c m·ª•c, th·ªùi gian d·ª± ki·∫øn (5-15 ph√∫t cho m·ªói m·ª•c) v√† ng∆∞·ªùi ph·ª• tr√°ch n·∫øu c√≥ th·ªÉ suy lu·∫≠n.`;
            const userPrompt = `T·∫°o m·ªôt b·∫£n nh√°p Agenda cu·ªôc h·ªçp d·ª±a tr√™n c√°c v·∫•n ƒë·ªÅ sau. ƒê·∫∑t t√™n cu·ªôc h·ªçp l√† "Cu·ªôc h·ªçp Tri·ªÉn khai v√† Ki·ªÉm tra c√¥ng t√°c Qu√Ω 4":
            ---
            ${notes}
            ---
            `;

            try {
                const textResponse = await callGeminiApiText(userPrompt, systemPrompt);
                const markdownResult = `## ‚ú® B·∫£n Nh√°p Agenda Chi Ti·∫øt\n\n${textResponse}`;
                displayResult(markdownResult);

            } catch (error) {
                console.error("L·ªói Gemini API:", error);
                showMessage(`L·ªói trong qu√° tr√¨nh t·∫°o agenda: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i.`, 'error');
                outputContainer.innerHTML = '<p class="text-red-500 italic p-4">ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng ki·ªÉm tra console log ƒë·ªÉ bi·∫øt chi ti·∫øt.</p>';
            } finally {
                setLoadingState(buttonId, false, '‚ú® ƒê·ªÅ Xu·∫•t Agenda M·∫´u');
            }
        };
        
        // CH·ª®C NƒÇNG 4: TR√çCH XU·∫§T M·ª§C H√ÄNH ƒê·ªòNG (S·ª≠ d·ª•ng JSON Schema)
        window.generateActionItems = async function() {
            const notes = document.getElementById('meeting-notes').value.trim();
            const buttonId = 'generate-action-button';

            if (!notes) {
                showMessage('Vui l√≤ng nh·∫≠p n·ªôi dung bi√™n b·∫£n h·ªçp.', 'error');
                return;
            }

            setLoadingState(buttonId, true, '‚ú® Tr√≠ch Xu·∫•t H√†nh ƒê·ªông & Ng∆∞·ªùi Ph·ª• Tr√°ch');
            hideMessage();

            const outputContainer = document.getElementById('output-container');
            outputContainer.innerHTML = '<div class="loader m-8 w-8 h-8" style="border-top-color: #ea580c;"></div><p class="text-center text-gray-500 mt-4">ƒêang tr√≠ch xu·∫•t v√† ph√¢n lo·∫°i c√°c m·ª•c h√†nh ƒë·ªông...</p>';

            const systemPrompt = `B·∫°n l√† tr·ª£ l√Ω qu·∫£n l√Ω d·ª± √°n. Nhi·ªám v·ª• c·ªßa b·∫°n l√† ph√¢n t√≠ch bi√™n b·∫£n cu·ªôc h·ªçp, tr√≠ch xu·∫•t t·∫•t c·∫£ c√°c m·ª•c h√†nh ƒë·ªông (action items) r√µ r√†ng v√† ng·∫ßm ƒë·ªãnh, x√°c ƒë·ªãnh ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám v√† ƒë√°nh gi√° m·ª©c ƒë·ªô ∆∞u ti√™n.
            Ph·∫£n h·ªìi PH·∫¢I l√† m·ªôt m·∫£ng JSON tu√¢n th·ªß schema ƒë√£ ƒë·ªãnh nghƒ©a. Ng√¥n ng·ªØ s·ª≠ d·ª•ng PH·∫¢I l√† ti·∫øng Vi·ªát.`;
            
            const userPrompt = `Tr√≠ch xu·∫•t t·∫•t c·∫£ c√°c m·ª•c h√†nh ƒë·ªông, ng∆∞·ªùi ph·ª• tr√°ch v√† m·ª©c ƒë·ªô ∆∞u ti√™n (Cao, Trung b√¨nh, Th·∫•p) t·ª´ bi√™n b·∫£n sau:
            ---
            ${notes}
            ---
            `;

            try {
                const jsonResponse = await callGeminiApiJson(userPrompt, ACTION_ITEM_SCHEMA, systemPrompt);
                const markdownResult = formatActionItemsToMarkdown(jsonResponse);
                displayResult(markdownResult);

            } catch (error) {
                console.error("L·ªói Gemini API:", error);
                showMessage(`L·ªói trong qu√° tr√¨nh tr√≠ch xu·∫•t h√†nh ƒë·ªông: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i.`, 'error');
                outputContainer.innerHTML = '<p class="text-red-500 italic p-4">ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng ki·ªÉm tra console log ƒë·ªÉ bi·∫øt chi ti·∫øt.</p>';
            } finally {
                setLoadingState(buttonId, false, '‚ú® Tr√≠ch Xu·∫•t H√†nh ƒê·ªông & Ng∆∞·ªùi Ph·ª• Tr√°ch');
            }
        };
        
        // CH·ª®C NƒÇNG 5: SO·∫†N TH·∫¢O EMAIL T√ìM T·∫ÆT (S·ª≠ d·ª•ng Text response)
        window.generateFollowupEmail = async function() {
            const notes = document.getElementById('meeting-notes').value.trim();
            const buttonId = 'generate-email-button';

            if (!notes) {
                showMessage('Vui l√≤ng nh·∫≠p n·ªôi dung bi√™n b·∫£n h·ªçp.', 'error');
                return;
            }

            setLoadingState(buttonId, true, '‚ú® So·∫°n Th·∫£o Email T√≥m T·∫Øt');
            hideMessage();

            const outputContainer = document.getElementById('output-container');
            outputContainer.innerHTML = '<div class="loader m-8 w-8 h-8" style="border-top-color: #4f46e5;"></div><p class="text-center text-gray-500 mt-4">ƒêang so·∫°n b·∫£n nh√°p email...</p>';

            const systemPrompt = `B·∫°n l√† tr·ª£ l√Ω h√†nh ch√≠nh c·∫•p cao. Nhi·ªám v·ª• c·ªßa b·∫°n l√† so·∫°n m·ªôt b·∫£n nh√°p email chuy√™n nghi·ªáp, g·ª≠i cho t·∫•t c·∫£ ng∆∞·ªùi tham gia cu·ªôc h·ªçp. Email PH·∫¢I bao g·ªìm c√°c ph·∫ßn sau, s·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng Markdown:
            1. Ti√™u ƒë·ªÅ Email (Subject): Ng·∫Øn g·ªçn, n√™u b·∫≠t m·ª•c ƒë√≠ch (v√≠ d·ª•: [T√ìM T·∫ÆT] - Cu·ªôc h·ªçp [T√™n d·ª± √°n] - [Ng√†y]).
            2. Th√¢n b√†i: C·∫£m ∆°n s·ª± tham gia v√† t√≥m t·∫Øt ng·∫Øn c√°c quy·∫øt ƒë·ªãnh ch√≠nh.
            3. M·ª•c H√†nh ƒê·ªông (Action Items): Li·ªát k√™ c√°c nhi·ªám v·ª•, ng∆∞·ªùi ph·ª• tr√°ch v√† th·ªùi h·∫°n (n·∫øu c√≥ th·ªÉ suy lu·∫≠n).
            4. M·ª•c Ti·∫øp Theo: ƒê·ªÅ xu·∫•t ng√†y/gi·ªù cho cu·ªôc h·ªçp ti·∫øp theo (ho·∫∑c th√¥ng b√°o s·∫Ω c·∫≠p nh·∫≠t sau).

            S·ª≠ d·ª•ng ti·∫øng Vi·ªát trang tr·ªçng, l·ªãch s·ª±.`;
            
            const userPrompt = `D·ª±a tr√™n bi√™n b·∫£n h·ªçp sau, so·∫°n m·ªôt b·∫£n nh√°p email t·ªïng k·∫øt:
            ---
            ${notes}
            ---
            `;

            try {
                const textResponse = await callGeminiApiText(userPrompt, systemPrompt);
                const markdownResult = `## ‚ú® B·∫£n Nh√°p Email T√≥m T·∫Øt Cu·ªôc H·ªçp\n\n${textResponse}`;
                displayResult(markdownResult);

            } catch (error) {
                console.error("L·ªói Gemini API:", error);
                showMessage(`L·ªói trong qu√° tr√¨nh so·∫°n email: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i.`, 'error');
                outputContainer.innerHTML = '<p class="text-red-500 italic p-4">ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng ki·ªÉm tra console log ƒë·ªÉ bi·∫øt chi ti·∫øt.</p>';
            } finally {
                setLoadingState(buttonId, false, '‚ú® So·∫°n Th·∫£o Email T√≥m T·∫Øt');
            }
        };

        // CH·ª®C NƒÇNG 6: PH√ÇN T√çCH R·ª¶I RO & C∆† H·ªòI (S·ª≠ d·ª•ng JSON Schema)
        window.analyzeRisksAndOpportunities = async function() {
            const notes = document.getElementById('meeting-notes').value.trim();
            const buttonId = 'generate-risk-button';

            if (!notes) {
                showMessage('Vui l√≤ng nh·∫≠p n·ªôi dung bi√™n b·∫£n h·ªçp.', 'error');
                return;
            }

            setLoadingState(buttonId, true, '‚ú® Ph√¢n T√≠ch R·ªßi Ro & C∆° H·ªôi');
            hideMessage();

            const outputContainer = document.getElementById('output-container');
            outputContainer.innerHTML = '<div class="loader m-8 w-8 h-8" style="border-top-color: #0d9488;"></div><p class="text-center text-gray-500 mt-4">ƒêang ph√¢n t√≠ch r·ªßi ro v√† c∆° h·ªôi...</p>';

            const systemPrompt = `B·∫°n l√† c·ªë v·∫•n chi·∫øn l∆∞·ª£c. Nhi·ªám v·ª• c·ªßa b·∫°n l√† ƒë·ªçc v√† ph√¢n t√≠ch bi√™n b·∫£n cu·ªôc h·ªçp, tr√≠ch xu·∫•t v√† ph√¢n lo·∫°i m·ªôt c√°ch r√µ r√†ng c√°c R·ªßi ro (Risks) ho·∫∑c Th√°ch th·ª©c (Challenges) ti·ªÅm ·∫©n v√† c√°c C∆° h·ªôi (Opportunities) ho·∫∑c B∆∞·ªõc ti·∫øp theo t√≠ch c·ª±c.
            M·ªói R·ªßi ro PH·∫¢I ƒëi k√®m v·ªõi m·ªôt ƒê·ªÅ xu·∫•t gi·∫£m thi·ªÉu (Mitigation Suggestion) ng·∫Øn g·ªçn.
            M·ªói C∆° h·ªôi PH·∫¢I ƒëi k√®m v·ªõi m·ªôt ƒê·ªÅ xu·∫•t khai th√°c (Action Suggestion) ng·∫Øn g·ªçn.
            Ph·∫£n h·ªìi PH·∫¢I l√† m·ªôt ƒë·ªëi t∆∞·ª£ng JSON tu√¢n th·ªß schema ƒë√£ ƒë·ªãnh nghƒ©a. Ng√¥n ng·ªØ s·ª≠ d·ª•ng PH·∫¢I l√† ti·∫øng Vi·ªát.`;
            
            const userPrompt = `Ph√¢n t√≠ch bi√™n b·∫£n cu·ªôc h·ªçp sau ƒë·ªÉ x√°c ƒë·ªãnh R·ªßi ro v√† C∆° h·ªôi ti·ªÅm ·∫©n.
            ---
            ${notes}
            ---
            `;

            try {
                const jsonResponse = await callGeminiApiJson(userPrompt, RISK_OPP_SCHEMA, systemPrompt);
                const markdownResult = formatRiskOppToMarkdown(jsonResponse);
                displayResult(markdownResult);

            } catch (error) {
                console.error("L·ªói Gemini API:", error);
                showMessage(`L·ªói trong qu√° tr√¨nh ph√¢n t√≠ch r·ªßi ro/c∆° h·ªôi: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i.`, 'error');
                outputContainer.innerHTML = '<p class="text-red-500 italic p-4">ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng ki·ªÉm tra console log ƒë·ªÉ bi·∫øt chi ti·∫øt.</p>';
            } finally {
                setLoadingState(buttonId, false, '‚ú® Ph√¢n T√≠ch R·ªßi Ro & C∆° H·ªôi');
            }
        };


        // H√†m sao ch√©p n·ªôi dung ƒë√£ ƒë·ªãnh d·∫°ng Markdown
        window.copyToClipboard = function() {
            const outputContainer = document.getElementById('output-container');
            const markdownContent = outputContainer.getAttribute('data-markdown-content');
            
            if (markdownContent) {
                // D√πng document.execCommand('copy') ƒë·ªÉ ƒë·∫£m b·∫£o ho·∫°t ƒë·ªông trong iFrame
                const tempTextArea = document.createElement("textarea");
                tempTextArea.value = markdownContent;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                try {
                    document.execCommand('copy');
                    showMessage('ƒê√£ sao ch√©p n·ªôi dung (Markdown) v√†o clipboard!', 'success');
                } catch (err) {
                    console.error('Kh√¥ng th·ªÉ sao ch√©p: ', err);
                    showMessage('Kh√¥ng th·ªÉ sao ch√©p. Vui l√≤ng sao ch√©p th·ªß c√¥ng.', 'error');
                }
                document.body.removeChild(tempTextArea);
            } else {
                showMessage('Kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ sao ch√©p.', 'error');
            }
        }
    </script>
</body>
</html>
