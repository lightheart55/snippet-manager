<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trợ lý Biên tập Biên bản Họp</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải thư viện Marked.js để render Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Sử dụng font Inter cho toàn bộ trang */
        body {
            font-family: "Inter", sans-serif;
        }
        /* Tùy chỉnh thanh cuộn cho đẹp hơn */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* CSS cho spinner loading */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #FF3D00;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- TIÊU ĐỀ -->
        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Trợ lý Biên tập Biên bản Họp</h1>
            <p class="text-gray-600 mt-1">Dán nội dung họp thô để biên tập lại theo chuẩn hành chính.</p>
        </header>

        <!-- NỘI DUNG CHÍNH: HAI CỘT -->
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- CỘT BÊN TRÁI: NHẬP LIỆU -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <label for="raw-input" class="text-lg font-semibold text-gray-700">Nội dung họp thô:</label>
                <textarea id="raw-input"
                    class="w-full h-96 md:h-[60vh] mt-4 p-4 border border-gray-300 rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Dán nội dung ghi chú, gạch đầu dòng, tường thuật lộn xộn của bạn vào đây..."></textarea>
                <button id="format-button"
                    class="mt-4 w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-blue-700 transition duration-300 flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    <span>Biên tập & Chuẩn hóa</span>
                </button>
            </div>

            <!-- CỘT BÊN PHẢI: XUẤT LIỆU -->
            <div class="bg-gray-800 text-white p-6 rounded-lg shadow-md">
                <!-- Tabs điều khiển -->
                <div class="flex border-b border-gray-700 mb-4">
                    <button id="tab-preview" class="py-2 px-4 font-semibold text-white border-b-2 border-blue-500">Xem trước</button>
                    <button id="tab-markdown" class="py-2 px-4 font-semibold text-gray-400">Markdown</button>
                    <button id="copy-button" class="ml-auto py-2 px-4 bg-gray-700 hover:bg-gray-600 rounded-md text-sm font-medium flex items-center space-x-1.5">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        <span>Sao chép</span>
                    </button>
                </div>
                
                <!-- Vùng hiển thị nội dung -->
                <div id="output-container" class="relative w-full h-96 md:h-[60vh] overflow-y-auto">
                    <!-- Tab Xem trước -->
                    <div id="preview-output" class="prose prose-invert max-w-none p-2">
                        <p class="text-gray-400">Nội dung biên tập sẽ xuất hiện ở đây...</p>
                    </div>
                    <!-- Tab Mã Markdown -->
                    <pre id="markdown-output" class="p-2 whitespace-pre-wrap break-words" style="display: none;"></pre>

                    <!-- Lớp phủ Loading -->
                    <div id="loading-overlay" class="absolute inset-0 bg-gray-800 bg-opacity-75 flex flex-col items-center justify-center rounded-lg" style="display: none;">
                        <div class="loader"></div>
                        <p class="text-white text-lg font-semibold mt-4">Đang biên tập...</p>
                    </div>
                    <!-- Thông báo sao chép -->
                    <div id="copy-success" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg font-semibold" style="display: none;">
                        Đã sao chép!
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Định nghĩa vai trò hệ thống cho AI
        const systemPrompt = `Bạn là Trợ lý biên tập biên bản họp chuyên nghiệp, hiểu ngôn ngữ hội họp hành chính Việt Nam, giọng lãnh đạo, nghiêm túc, rõ ràng, có điểm nhấn và đúng tinh thần phát biểu trong các cuộc họp ngành y tế.
Nhiệm vụ:
Khi tôi nhập nội dung thô (dạng gạch đầu dòng, tường thuật, lời nói ngắn, ghi chú lộn xộn), bạn phải biên soạn lại thành bản biên bản họp chuẩn hành chính, rõ ràng, có thể dùng để in hoặc lưu hành nội bộ.
Cấu trúc bắt buộc:
**Mục tiêu cuộc họp**
* Tóm tắt 1–2 ý ngắn gọn nêu mục tiêu hoặc trọng tâm buổi họp.
* Viết bằng dấu “•”, không giải thích dài dòng.
**[Tên người phát biểu] – [Chức vụ / Lĩnh vực phụ trách]**
* Viết lại phát biểu của người này theo giọng hành chính – lãnh đạo – nghiêm túc, dùng câu ngắn, dứt khoát.
* Mỗi ý chính trình bày trên một dòng riêng, có thể dùng “–” hoặc “•” đầu dòng.
* Nhấn mạnh nội dung quan trọng bằng chữ **đậm** (ví dụ: **phải làm ngay**, **không để chậm**, **rút kinh nghiệm**, **báo cáo kịp thời**…).
* Nếu có yêu cầu, đề nghị, hoặc phê bình, thể hiện rõ ràng bằng ngữ điệu chỉ đạo.
Sau mỗi người phát biểu, chèn một đường phân cách:
________________________________________
Quy tắc trình bày:
* Dạng Markdown.
* Không thêm tiêu đề thừa như “Biên bản”, “Nội dung họp”.
* Không sáng tạo ngoài nội dung gốc, chỉ chuyển hóa lời nói thô thành văn bản hành chính rõ ràng.
* Giữ phong cách trang trọng, mạch lạc, dễ nhìn, đọc hiểu ngay.
* Không thêm “Kết luận” hay “Tổng kết” nếu nội dung không có.
* Nếu có người chủ trì, ghi phần cuối:
**[Tên người – Chủ trì cuộc họp]**, trình bày theo giọng quán triệt – giao việc – nhấn trọng tâm.`;

        // Lấy các phần tử DOM
        const formatButton = document.getElementById('format-button');
        const rawInput = document.getElementById('raw-input');
        const previewOutput = document.getElementById('preview-output');
        const markdownOutput = document.getElementById('markdown-output');
        const loadingOverlay = document.getElementById('loading-overlay');
        const copyButton = document.getElementById('copy-button');
        const copySuccess = document.getElementById('copy-success');
        const tabPreview = document.getElementById('tab-preview');
        const tabMarkdown = document.getElementById('tab-markdown');

        let formattedText = ""; // Biến lưu trữ văn bản đã định dạng

        // Xử lý chuyển tab
        tabPreview.addEventListener('click', () => {
            previewOutput.style.display = 'block';
            markdownOutput.style.display = 'none';
            tabPreview.classList.add('border-blue-500', 'text-white');
            tabPreview.classList.remove('text-gray-400');
            tabMarkdown.classList.remove('border-blue-500', 'text-white');
            tabMarkdown.classList.add('text-gray-400');
        });

        tabMarkdown.addEventListener('click', () => {
            previewOutput.style.display = 'none';
            markdownOutput.style.display = 'block';
            tabMarkdown.classList.add('border-blue-500', 'text-white');
            tabMarkdown.classList.remove('text-gray-400');
            tabPreview.classList.remove('border-blue-500', 'text-white');
            tabPreview.classList.add('text-gray-400');
        });

        // Xử lý sự kiện nhấp nút "Biên tập"
        formatButton.addEventListener('click', async () => {
            const userQuery = rawInput.value;
            if (!userQuery.trim()) {
                previewOutput.innerHTML = '<p class="text-yellow-400">Vui lòng nhập nội dung thô trước khi biên tập.</p>';
                return;
            }

            loadingOverlay.style.display = 'flex'; // Hiện loading
            formatButton.disabled = true;

            try {
                const result = await callGeminiAPI(systemPrompt, userQuery);
                formattedText = result; // Lưu kết quả

                // Hiển thị ở cả hai tab
                previewOutput.innerHTML = marked.parse(result); // Render HTML
                markdownOutput.textContent = result; // Hiển thị mã Markdown thô
                
                // Tự động chuyển sang tab xem trước
                tabPreview.click();

            } catch (error) {
                console.error('Lỗi khi gọi API:', error);
                previewOutput.innerHTML = `<p class="text-red-400">Đã xảy ra lỗi khi biên tập. Vui lòng thử lại.\n${error.message}</p>`;
            } finally {
                loadingOverlay.style.display = 'none'; // Ẩn loading
                formatButton.disabled = false;
            }
        });

        // Xử lý sao chép
        copyButton.addEventListener('click', () => {
            if (!formattedText) return;
            
            // Sử dụng document.execCommand để tương thích tốt hơn trong iframe
            const textarea = document.createElement('textarea');
            textarea.value = formattedText;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                // Hiển thị thông báo thành công
                copySuccess.style.display = 'block';
                setTimeout(() => {
                    copySuccess.style.display = 'none';
                }, 1500);
            } catch (err) {
                console.error('Không thể sao chép:', err);
                alert('Không thể sao chép. Vui lòng sao chép thủ công từ tab Markdown.');
            }
            document.body.removeChild(textarea);
        });

        // Hàm gọi Gemini API với xử lý retry (exponential backoff)
        async function callGeminiAPI(systemPrompt, userQuery, retries = 3, delay = 1000) {
            const apiKey = ""; // Canvas sẽ tự động thêm key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [{ text: userQuery }]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0].content?.parts?.[0]?.text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('Định dạng phản hồi API không hợp lệ.');
                    }

                } catch (error) {
                    console.warn(`Lỗi API (lần ${i + 1}):`, error.message);
                    if (i === retries - 1) { // Lần thử cuối cùng
                        throw error; // Ném lỗi ra ngoài
                    }
                    await new Promise(resolve => setTimeout(resolve, delay)); // Chờ
                    delay *= 2; // Tăng gấp đôi thời gian chờ
                }
            }
        }
    </script>
</body>
</html>
